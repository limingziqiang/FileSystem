"use strict";var _createClass=function(){function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(e,t,n){return t&&r(e.prototype,t),n&&r(e,n),e}}();function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}!function(){var u={INITIALIZE_FAILED:"文件系统初始化失败",FILE_EXISTED:"文件已存在",Directory_EXISTED:"目录已存在",ONLY_FILE_WRITE:"只有文件才能写入",NOT_ENTRY:"不是有效的Entry对象",INVALID_PATH:'文件或者目录不能包含\\/:*?"<>|'},c="/",n=String.fromCharCode(c.charCodeAt(0)+1),f={_pathBlackList:/[\\:*?"<>|]/,resolveToFullPath:function(e,t){var n=t;t[0]!=c&&(n=e+c+t);for(var r=n.split(c),i=[],a=0;a<r.length;++a){var s=r[a];if(".."===s){if(!i.length)throw Error("Invalid path");i.pop()}else"."===s||""!==s&&i.push(s)}return n=c+i.join(c)},isValidatedPath:function(e){return!this._pathBlackList.test(e)}},h=function e(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{code:999,message:"未知错误"},n=t.code,r=void 0===n?999:n,i=t.message,a=void 0===i?"未知错误":i;_classCallCheck(this,e),this.code=r,this.message=a},r=function e(t,n){_classCallCheck(this,e),this.modificationTime=t,this.size=n},d=function e(t,n,r,i,a){_classCallCheck(this,e),this.name=t,this.size=n,this.type=r,this.lastModifiedDate=i,this.blob=a},s={read:function(i,a){var s=arguments;return new Promise(function(e,t){var n=new FileReader,r=[].slice.call(s,2);r.unshift(i),n[a].apply(n,r),n.onload=function(){return e(n.result)},n.onerror=function(e){return t(e)},n.onabort=function(){return t(new Error("读取被中断"))}})},readAsArrayBuffer:function(e){return this.read(e,"readAsArrayBuffer")},readAsBinaryString:function(e){return this.read(e,"readAsBinaryString")},readAsDataURL:function(e){return this.read(e,"readAsDataURL")},readAsText:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"gb2312";return this.read(e,"readAsText",t)}},e=new h({code:1e3,message:"方法未实现"}),t=(new h({code:404,message:"未找到"}),new Error("")),y=function(){function i(){var e=!(0<arguments.length&&void 0!==arguments[0])||arguments[0],t=1<arguments.length&&void 0!==arguments[1]&&arguments[1],n=arguments[2],r=arguments[3];_classCallCheck(this,i),this.isFile=e,this.isDirectory=t,this.name=n,this.fullPath=r,this.metadata={lastModifiedDate:new Date,size:0}}return _createClass(i,[{key:"getMetadata",value:function(){return this._dispatch("getMetadata")}},{key:"moveTo",value:function(){throw e}},{key:"copyTo",value:function(){throw e}},{key:"toURL",value:function(){return this._dispatch("toURL")}},{key:"remove",value:function(){return this._dispatch("remove")}},{key:"getParent",value:function(){return this._dispatch("getParent")}}]),i}();y.prototype._dispatch=function(r){for(var i=this,e=arguments.length,a=Array(1<e?e-1:0),t=1;t<e;t++)a[t-1]=arguments[t];return new Promise(function(n){var e;return o._instance?n((e=o._instance)[r].apply(e,[i].concat(a))):o.getInstance().then(function(e){var t;return o._instance=e,n((t=o._instance)[r].apply(t,[i].concat(a)))})})},y.copyFrom=function(e){var t=e.isFile?new _(e.name,e.fullPath,e.file):new v(e.name,e.fullPath);return t.metadata=e.metadata,t};var _=function(e){function i(e,t,n){_classCallCheck(this,i);var r=_possibleConstructorReturn(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,!0,!1,e,t));return r.file=n,r}return _inherits(i,y),_createClass(i,[{key:"write",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"text/plain",n=2<arguments.length&&void 0!==arguments[2]&&arguments[2];return this._dispatch("write",e,t,n)}},{key:"getBlob",value:function(){return this._dispatch("getBlob")}},{key:"readAsArrayBuffer",value:function(){return this._dispatch("readFile","readAsArrayBuffer")}},{key:"readAsBinaryString",value:function(){return this._dispatch("readFile","readAsBinaryString")}},{key:"readAsDataURL",value:function(){return this._dispatch("readFile","readAsDataURL")}},{key:"readAsText",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"utf-8";return this._dispatch("readFile","readAsText",e)}}]),i}(),v=function(e){function n(e,t){return _classCallCheck(this,n),_possibleConstructorReturn(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,!1,!0,e,t))}return _inherits(n,y),_createClass(n,[{key:"getFile",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{create:!0,exclusive:!1};return f.isValidatedPath(e)?this._dispatch("getFile",e,t):Promise.reject(u.INVALID_PATH)}},{key:"getDirectory",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{create:!0,exclusive:!1};return f.isValidatedPath(e)?this._dispatch("getDirectory",e,t):Promise.reject(u.INVALID_PATH)}},{key:"remove",value:function(){return this._dispatch("removeRecursively")}},{key:"getEntries",value:function(){return this._dispatch("getEntries")}},{key:"ensureDirectory",value:function(e){return this._dispatch("ensureDirectory",e)}}]),n}(),o=function(){function a(){_classCallCheck(this,a),this._db=null,this._instance=null,this._storeName=a._storeName,this.root=null,this._state=0}return _createClass(a,[{key:"_toPromise",value:function(a){for(var s=this,e=arguments.length,o=Array(1<e?e-1:0),t=1;t<e;t++)o[t-1]=arguments[t];try{var l=void 0;return 1<=o.length&&"function"==typeof o[o.length-1]&&(l=o[o.length-1],o=o.slice(0,o.length-1)),new Promise(function(e,t){var n,r=s.transaction,i=(n=r.objectStore(s._storeName))[a].apply(n,_toConsumableArray(o));0<=["openCursor","openKeyCursor"].indexOf(a)&&l?(i.onsuccess=function(e){l(e)},r.oncomplete=function(){return e()},r.onsuccess=function(){return e()}):(r.oncomplete=function(){return e(i.result)},r.onsuccess=function(){return e(i.result)}),i.onerror=function(){return t(i.error)},r.onerror=function(){return t(r.error)}})}catch(e){return Promise.reject(e)}}},{key:"write",value:function(e,t){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:"text/plain";3<arguments.length&&void 0!==arguments[3]&&arguments[3];if(this._checkEntry(e),!0!==e.isFile)throw new h({message:u.ONLY_FILE_WRITE});var r=t;r=t instanceof ArrayBuffer?new Blob([new Uint8Array(t)],{type:n}):"string"==typeof t?new Blob([t],{type:"text/plain"}):new Blob([t],{type:n});var i=e.file;return i?(i.lastModifiedDate=new Date,i.type=n,i.size=r.size,i.blob=r,e.metadata.lastModifiedDate=i.lastModifiedDate,e.metadata.size=r.size):(i=new d(e.fullPath.split(c).pop(),r.size,n,new Date,r),e.metadata.lastModifiedDate=i.lastModifiedDate,e.metadata.size=r.size,e.file=i),this._toPromise("put",e,e.fullPath).then(function(){return e})}},{key:"getFile",value:function(e,t,n){n.create,n.exclusive;return this.getEntry.apply(this,Array.prototype.slice.call(arguments).concat([!0]))}},{key:"getDirectory",value:function(e,t,n){n.create,n.exclusive;return this.getEntry.apply(this,Array.prototype.slice.call(arguments).concat([!1]))}},{key:"remove",value:function(e){return this._checkEntry(e),this._toPromise("delete",e.fullPath).then(function(){return!0})}},{key:"removeRecursively",value:function(e){this._checkEntry(e);var t=IDBKeyRange.bound(e.fullPath,e.fullPath+n,!1,!0);return this._toPromise("delete",t).then(function(){return!0})}},{key:"getMetadata",value:function(e){var t=e.file||{};return new r(t&&t.lastModifiedDate||null,t&&t.size||0)}},{key:"getEntry",value:function(e,i,t){var a=this,s=t.create,n=t.exclusive,o=void 0!==n&&n,l=!(3<arguments.length&&void 0!==arguments[3])||arguments[3];return this._checkEntry(e),i===c?e:(i=f.resolveToFullPath(e.fullPath,i),this._toPromise("get",i).then(function(e){if(!0===s&&!0===o&&e)throw new h({message:l?u.FILE_EXISTED:u.Directory_EXISTED});if(!0!==s||e){if(s||e){if(e&&e.isDirectory&&l||e&&e.isFile&&!l)throw new h({code:1001,message:l?u.Directory_EXISTED:u.FILE_EXISTED});return y.copyFrom(e)}return null}var t=i.split(c).pop(),n=l?new _(t,i):new v(t,i),r=l?new d(t,0,null,new Date,null):null;return l&&(n.file=r),a._toPromise("put",n,n.fullPath).then(function(){return y.copyFrom(n)})}))}},{key:"getParent",value:function(e){if(this._checkEntry(e),e.fullPath===c)return e;var t=e.fullPath.substring(0,e.fullPath.lastIndexOf(c));return""===t?this.root:this.getDirectory(this.root,t,{create:!1},!1)}},{key:"getEntries",value:function(r){var e=null,i=[];r.fullPath!=c&&""!=r.fullPath&&(e=IDBKeyRange.bound(r.fullPath+c,r.fullPath+n,!1,!0));var a=void 0,s=void 0;return this._toPromise("openCursor",e,function(e){var t=e.target.result;if(t){var n=t.value;a=n.fullPath.split(c).length,s=r.fullPath.split(c).length,n.fullPath!==c&&(r.fullPath===c&&a<s+1||r.fullPath!==c&&a===s+1)&&i.push(n.isFile?new _(n.name,n.fullPath,n.file):new v(n.name,n.fullPath)),t.continue()}}).then(function(){return i})}},{key:"toURL",value:function(e){return this._checkEntry(e),e.file&&e.file.blob?URL.createObjectURL(e.file.blob):null}},{key:"readFile",value:function(e,t){if(this._checkEntry(e),e.file&&e.file.blob){for(var n=arguments.length,r=Array(2<n?n-2:0),i=2;i<n;i++)r[i-2]=arguments[i];return s.read.apply(s,[e.file.blob,t].concat(r))}return null}},{key:"getBlob",value:function(e){return this._checkEntry(e),e.file&&e.file.blob?e.file.blob:null}},{key:"_checkEntry",value:function(e){if(!(e&&e instanceof y))throw new h({message:u.NOT_ENTRY})}},{key:"ensureDirectory",value:function(n,e){if(this._checkEntry(n),e===c)return n;var t=f.resolveToFullPath(n.fullPath,e);if(t.length<e.length)return n;var r,i,a,s,o,l=(e=t.substring(n.fullPath.length)).split(c);return(r=l,i=function(e,t){return n.getDirectory(l.slice(0,t+1).join("/"),{create:!0})},a=!0,s=[],o=Promise.resolve(),Array.from(r).forEach(function(e,t){o=o.then(function(){return i(e,t).then(function(e){a&&s.push(e)})})}),a?o.then(function(){return s}):o).then(function(e){return e&&e[e.length-1]}).catch(function(e){throw e})}},{key:"transaction",get:function(){return this._db.transaction([this._storeName],IDBTransaction.READ_WRITE||"readwrite")}}],[{key:"getInstance",value:function(){var i=this,r=0<arguments.length&&void 0!==arguments[0]?arguments[0]:1;if(!a.isSupported)throw t;return this._instance&&Promise.resolve(this._instance),1===this._state?new Promise(function(e,t){var n=0,r=setInterval(function(){return i._instance&&2==i._state?(n++,clearInterval(r),e(i._instance)):10<n?t(u.INITIALIZE_FAILED):void 0},5)}):(this._state=1,new Promise(function(t,e){var n=self.indexedDB.open(a._dbName,r);n.onerror=function(){return i._state=0,e(null)},n.onsuccess=function(){var e=n.result;return e.setVersion&&e.version!==r?(e.setVersion(r).onsuccess=function(){return e.createObjectStore(this._storeName),this._instance=new a,this._instance._db=n.result,this._instance.root=new v("/","/"),this._state=2,t(this._instance)},null):(i._instance=new a,i._instance._db=n.result,i._instance.root=new v("/","/"),i._state=2,t(i._instance))},n.onupgradeneeded=function(e){e.target.result.createObjectStore(i._storeName)}}))}}]),a}();o.isSupported=function(){return self.indexedDB_=self.indexedDB||self.mozIndexedDB||self.webkitIndexedDB||self.msIndexedDB,self.IDBTransaction=self.IDBTransaction||self.webkitIDBTransaction||self.msIDBTransaction,self.IDBKeyRange=self.IDBKeyRange||self.webkitIDBKeyRange||self.msIDBKeyRange,!!(self.indexedDB&&self.IDBTransaction&&self.IDBKeyRange)},o._dbName="_fs_db_",o._storeName="_fs_store",self.FILE_ERROR=u,self.URLUtil=f,self.ReaderUtil=s,self.Entry=y,self.FileEntry=_,self.DirectoryEntry=v,self.FileSystem=o}(self);