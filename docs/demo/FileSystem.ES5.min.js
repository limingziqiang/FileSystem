"use strict";var _createClass=function(){function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(e,t,n){return t&&r(e.prototype,t),n&&r(e,n),e}}();function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}!function(){var u={INITIALIZE_FAILED:"文件系统初始化失败",FILE_EXISTED:"文件已存在",Directory_EXISTED:"目录已存在",ONLY_FILE_WRITE:"只有文件才能写入",NOT_ENTRY:"不是有效的Entry对象",INVALID_PATH:'文件或者目录不能包含\\/:*?"<>|'},c="/",n=String.fromCharCode(c.charCodeAt(0)+1),f={_pathBlackList:/[\\:*?"<>|]/,resolveToFullPath:function(e,t){var n=t;t[0]!=c&&(n=e+c+t);for(var r=n.split(c),i=[],a=0;a<r.length;++a){var o=r[a];if(".."===o){if(!i.length)throw Error("Invalid path");i.pop()}else"."===o||""!==o&&i.push(o)}return n=c+i.join(c)},isValidatedPath:function(e){return!this._pathBlackList.test(e)}},h=function e(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{code:999,message:"未知错误"},n=t.code,r=void 0===n?999:n,i=t.message,a=void 0===i?"未知错误":i;_classCallCheck(this,e),this.code=r,this.message=a},i=function e(t,n){_classCallCheck(this,e),this.modificationTime=t,this.size=n},d=function e(t,n,r,i,a){_classCallCheck(this,e),this.name=t,this.size=n,this.type=r,this.lastModifiedDate=i,this.blob=a},a={read:function(i,a){var o=arguments;return new Promise(function(e,t){var n=new FileReader,r=[].slice.call(o,2);r.unshift(i),n[a].apply(n,r),n.onload=function(){return e(n.result)},n.onerror=function(e){return t(e)},n.onabort=function(){return t(new Error("读取被中断"))}})},readAsArrayBuffer:function(e){return this.read(e,"readAsArrayBuffer")},readAsBinaryString:function(e){return this.read(e,"readAsBinaryString")},readAsDataURL:function(e){return this.read(e,"readAsDataURL")},readAsText:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"gb2312";return this.read(e,"readAsText",t)}},e=new h({code:1e3,message:"方法未实现"}),r=new Error("浏览器不支持改功能"),o=function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"text/plain";return e instanceof Blob?e:e instanceof ArrayBuffer?new Blob([new Uint8Array(e)],{type:t}):"string"==typeof e?new Blob([e],{type:"text/plain"}):new Blob([e],{type:t})},y=function(){function i(){var e=!(0<arguments.length&&void 0!==arguments[0])||arguments[0],t=1<arguments.length&&void 0!==arguments[1]&&arguments[1],n=arguments[2],r=arguments[3];_classCallCheck(this,i),this.isFile=e,this.isDirectory=t,this.name=n,this.fullPath=r,this.metadata={lastModifiedDate:new Date,size:0}}return _createClass(i,[{key:"getMetadata",value:function(){return this._dispatch("getMetadata")}},{key:"moveTo",value:function(){throw e}},{key:"copyTo",value:function(){throw e}},{key:"toURL",value:function(){return this._dispatch("toURL")}},{key:"remove",value:function(){return this._dispatch("remove")}},{key:"getParent",value:function(){return this._dispatch("getParent")}}]),i}();y.prototype._dispatch=function(r){for(var i=this,e=arguments.length,a=Array(1<e?e-1:0),t=1;t<e;t++)a[t-1]=arguments[t];return new Promise(function(n){var e;return s._instance?n((e=s._instance._provider)[r].apply(e,[i].concat(a))):s.getInstance().then(function(e){var t;return s._instance=e,n((t=s._instance._provider)[r].apply(t,[i].concat(a)))})})},y.copyFrom=function(e){var t=e.isFile?new v(e.name,e.fullPath,e.file):new _(e.name,e.fullPath);return t.metadata=e.metadata,t};var v=function(e){function i(e,t,n){_classCallCheck(this,i);var r=_possibleConstructorReturn(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,!0,!1,e,t));return r.file=n,r}return _inherits(i,y),_createClass(i,[{key:"write",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"text/plain",n=2<arguments.length&&void 0!==arguments[2]&&arguments[2];return n?this.append(e):this._dispatch("write",e,t,n)}},{key:"append",value:function(t){return this.getBlob().then(function(e){return this.write(new Blob([e,o(t,e.type)]))}.bind(this))}},{key:"getBlob",value:function(){return this._dispatch("getBlob")}},{key:"readAsArrayBuffer",value:function(){return this._dispatch("readFile","readAsArrayBuffer")}},{key:"readAsBinaryString",value:function(){return this._dispatch("readFile","readAsBinaryString")}},{key:"readAsDataURL",value:function(){return this._dispatch("readFile","readAsDataURL")}},{key:"readAsText",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"utf-8";return this._dispatch("readFile","readAsText",e)}}]),i}(),_=function(e){function n(e,t){return _classCallCheck(this,n),_possibleConstructorReturn(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,!1,!0,e,t))}return _inherits(n,y),_createClass(n,[{key:"getFile",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{create:!0,exclusive:!1};return f.isValidatedPath(e)?this._dispatch("getFile",e,t):Promise.reject(u.INVALID_PATH)}},{key:"getDirectory",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{create:!0,exclusive:!1};return f.isValidatedPath(e)?this._dispatch("getDirectory",e,t):Promise.reject(u.INVALID_PATH)}},{key:"remove",value:function(){return this._dispatch("removeRecursively")}},{key:"getEntries",value:function(){return this._dispatch("getEntries")}},{key:"ensureDirectory",value:function(e){return this._dispatch("ensureDirectory",e)}}]),n}(),s=function(){function n(){_classCallCheck(this,n),this._instance=null,this.root=null,this._provider=null}return _createClass(n,null,[{key:"getInstance",value:function(){var t=this,e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:1;if(!n.isSupported)throw r;return this._instance?Promise.resolve(this._instance):p.getInstance(e,n._dbName,n._storeName).then(function(e){return t._instance=new n,t._instance._provider=e,t._instance.root=new _("/","/"),delete t._instance._instance,t._instance})}}]),n}();s._dbName="_fs_db_",s._storeName="_fs_store";var l=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"getInstance",value:function(){var r=0<arguments.length&&void 0!==arguments[0]?arguments[0]:1,i=arguments[1],a=arguments[2];return new Promise(function(t,e){var n=self.indexedDB.open(i,r);n.onerror=function(){return e(null)},n.onsuccess=function(){var e=n.result;return e.setVersion&&e.version!==r?(e.setVersion(r).onsuccess=function(){return e.objectStoreNames.contains(a)||e.createObjectStore(a),t(e)},t(null)):t(e)},n.onupgradeneeded=function(e){var t=e.target.result;t.objectStoreNames.contains(a)||t.createObjectStore(a)}})}}]),e}(),p=function(){function r(e,t){_classCallCheck(this,r),this._db=e,this._storeName=t}return _createClass(r,[{key:"_toPromise",value:function(a){for(var o=this,e=arguments.length,s=Array(1<e?e-1:0),t=1;t<e;t++)s[t-1]=arguments[t];try{var l=void 0;return 1<=s.length&&"function"==typeof s[s.length-1]&&(l=s[s.length-1],s=s.slice(0,s.length-1)),new Promise(function(e,t){var n,r=o.transaction,i=(n=r.objectStore(o._storeName))[a].apply(n,_toConsumableArray(s));0<=["openCursor","openKeyCursor"].indexOf(a)&&l?(i.onsuccess=function(e){l(e)},r.oncomplete=function(){return e()},r.onsuccess=function(){return e()}):(r.oncomplete=function(){return e(i.result)},r.onsuccess=function(){return e(i.result)}),i.onerror=function(){return t(i.error)},r.onerror=function(){return t(r.error)}})}catch(e){return Promise.reject(e)}}},{key:"write",value:function(e,t){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:"text/plain";if(this._checkEntry(e),!0!==e.isFile)throw new h({message:u.ONLY_FILE_WRITE});var r=o(t,n),i=e.file;return i?(i.lastModifiedDate=new Date,i.type=n,i.size=r.size,i.blob=r,e.metadata.lastModifiedDate=i.lastModifiedDate,e.metadata.size=r.size):(i=new d(e.fullPath.split(c).pop(),r.size,n,new Date,r),e.metadata.lastModifiedDate=i.lastModifiedDate,e.metadata.size=r.size,e.file=i),this._toPromise("put",e,e.fullPath).then(function(){return e})}},{key:"getFile",value:function(e,t,n){n.create,n.exclusive;return this.getEntry.apply(this,Array.prototype.slice.call(arguments).concat([!0]))}},{key:"getDirectory",value:function(e,t,n){n.create,n.exclusive;return this.getEntry.apply(this,Array.prototype.slice.call(arguments).concat([!1]))}},{key:"remove",value:function(e){return this._checkEntry(e),this._toPromise("delete",e.fullPath).then(function(){return!0})}},{key:"removeRecursively",value:function(e){this._checkEntry(e);var t=IDBKeyRange.bound(e.fullPath,e.fullPath+n,!1,!0);return this._toPromise("delete",t).then(function(){return!0})}},{key:"getMetadata",value:function(e){var t=e.file||{};return new i(t&&t.lastModifiedDate||null,t&&t.size||0)}},{key:"getEntry",value:function(e,i,t){var a=this,o=t.create,n=t.exclusive,s=void 0!==n&&n,l=!(3<arguments.length&&void 0!==arguments[3])||arguments[3];return this._checkEntry(e),i===c?e:(i=f.resolveToFullPath(e.fullPath,i),this._toPromise("get",i).then(function(e){if(!0===o&&!0===s&&e)throw new h({message:l?u.FILE_EXISTED:u.Directory_EXISTED});if(!0!==o||e){if(o||e){if(e&&e.isDirectory&&l||e&&e.isFile&&!l)throw new h({code:1001,message:l?u.Directory_EXISTED:u.FILE_EXISTED});return y.copyFrom(e)}return null}var t=i.split(c).pop(),n=l?new v(t,i):new _(t,i),r=l?new d(t,0,null,new Date,null):null;return l&&(n.file=r),a._toPromise("put",n,n.fullPath).then(function(){return y.copyFrom(n)})}))}},{key:"getParent",value:function(e){if(this._checkEntry(e),e.fullPath===c)return e;var t=e.fullPath.substring(0,e.fullPath.lastIndexOf(c));return""===t?this.root:this.getDirectory(this.root,t,{create:!1},!1)}},{key:"getEntries",value:function(r){var e=null,i=[];r.fullPath!=c&&""!=r.fullPath&&(e=IDBKeyRange.bound(r.fullPath+c,r.fullPath+n,!1,!0));var a=void 0,o=void 0;return this._toPromise("openCursor",e,function(e){var t=e.target.result;if(t){var n=t.value;a=n.fullPath.split(c).length,o=r.fullPath.split(c).length,n.fullPath!==c&&(r.fullPath===c&&a<o+1||r.fullPath!==c&&a===o+1)&&i.push(n.isFile?new v(n.name,n.fullPath,n.file):new _(n.name,n.fullPath)),t.continue()}}).then(function(){return i})}},{key:"toURL",value:function(e){return this._checkEntry(e),e.file&&e.file.blob?URL.createObjectURL(e.file.blob):null}},{key:"readFile",value:function(e,t){if(this._checkEntry(e),e.file&&e.file.blob){for(var n=arguments.length,r=Array(2<n?n-2:0),i=2;i<n;i++)r[i-2]=arguments[i];return a.read.apply(a,[e.file.blob,t].concat(r))}return null}},{key:"getBlob",value:function(e){return this._checkEntry(e),e.file&&e.file.blob?e.file.blob:null}},{key:"_checkEntry",value:function(e){if(!(e&&e instanceof y))throw new h({message:u.NOT_ENTRY})}},{key:"ensureDirectory",value:function(n,e){if(this._checkEntry(n),e===c)return n;var t=f.resolveToFullPath(n.fullPath,e);if(t.length<e.length)return n;var r,i,a,o,s,l=(e=t.substring(n.fullPath.length)).split(c);return(r=l,i=function(e,t){return n.getDirectory(l.slice(0,t+1).join("/"),{create:!0})},a=!0,o=[],s=Promise.resolve(),Array.from(r).forEach(function(e,t){s=s.then(function(){return i(e,t).then(function(e){a&&o.push(e)})})}),a?s.then(function(){return o}):s).then(function(e){return e&&e[e.length-1]}).catch(function(e){throw e})}},{key:"transaction",get:function(){return this._db.transaction([this._storeName],IDBTransaction.READ_WRITE||"readwrite")}}],[{key:"getInstance",value:function(e,t,n){return l.getInstance(e,t,n).then(function(e){return new r(e,n)})}}]),r}();s.isSupported=function(){return self.indexedDB_=self.indexedDB||self.mozIndexedDB||self.webkitIndexedDB||self.msIndexedDB,self.IDBTransaction=self.IDBTransaction||self.webkitIDBTransaction||self.msIDBTransaction,self.IDBKeyRange=self.IDBKeyRange||self.webkitIDBKeyRange||self.msIDBKeyRange,!!(self.indexedDB&&self.IDBTransaction&&self.IDBKeyRange)},self.FILE_ERROR=u,self.URLUtil=f,self.ReaderUtil=a,self.Entry=y,self.FileEntry=v,self.DirectoryEntry=_,self.FileSystem=s}(self);